var x=require("casper").selectXPath,casper=require("casper").create(),inputSelector="input[class=search]",formInputSelector="form "+inputSelector,searchSubmitSelector="span[class='searchsubmit'][title='Get Tweets']",refreshSubmitSelector="span[class='refreshsubmit'][title='Refresh Search'][label='Refresh Search']",resetSubmitSelector="span[class='resetsubmit']",localhost="http://localhost/~dave/twittersearchfeed/",heroku="http://twittersearchfeed.herokuapp.com/",twitterSearchSite=localhost,autorefreshinterval=3e4,maxItems=50,removeLocalStorageDirectAccess=function(e){casper.evaluate(function(){localStorage.removeItem("feedModel")})},removeLocalStorageClickReset=function(e,t){casper.waitForSelector(resetSubmitSelector,function(){casper.click(resetSubmitSelector),t&&t()},function(){casper.capture(e+"neverSeeReset.png"),casper.assertExists(resetSubmitSelector,(e!==undefined?e:"No testName provided")+" looking for resetSubmit")})},removeLocalStorage=removeLocalStorageClickReset,feedItemLength=function(){return $(".feeditem").length},feedItemLengthGreaterThan=function(e){return casper.evaluate(feedItemLength)>e},queryValueFtn=function(){return $("input").val()},ProxyNoURLSetMsg="No URL set",ProxyURLTooLongMsg="URL too long",ProxyURLNotAuthorisedMsg="URL is not authorised",NoTweetResultsText="No Tweet results for",testsToRun=Array(1,2,3,4,5,6,7,8,9,10,11);casper.test.begin("Twitter Search Feed tests",{setUp:function(e){},test:function(e){casper.start(twitterSearchSite),removeLocalStorage("test initializer");var t=this;if(testsToRun.indexOf(1)!=-1){var n="Twitter Search Feed Test #1: down the middle test",r=n.replace(/\s+/g,"");casper.then(function(){t.enterTermAndClick(e,"test",n),casper.then(function(){casper.waitForSelector(".feeditem",function(){e.assertExists(".feeditem",n+" has "+".feeditem"),casper.then(function(){t.waitForRefreshAndClick(e,n),casper.then(function(){e.assertExists(refreshSubmitSelector,n+" last check")})})},function(){casper.capture(r+"NoFeedItemSoFail.png"),e.assertExists(".feeditem",n+" has "+".feeditem")})})})}testsToRun.indexOf(2)!=-1&&(casper.thenOpen(twitterSearchSite),casper.then(function(){var n="Twitter Search Feed Test #2: down the middle test after reload";t.waitForRefreshAndClick(casper.test,n),e.assertExists(refreshSubmitSelector,n)}));if(testsToRun.indexOf(3)!=-1){casper.thenOpen(twitterSearchSite+"/twitter-proxy.php?q=0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234");var i="Twitter Search Feed Test #3: No URL in too long a URL to proxy",s=i.replace(/\s+/g,"");casper.waitForText(ProxyNoURLSetMsg,function(){e.assertTextExists(ProxyNoURLSetMsg,i)},function(){e.assertTextExists(ProxyNoURLSetMsg,i)})}testsToRun.indexOf(4)!=-1&&casper.then(function(){var t=0;casper.thenOpen(twitterSearchSite);var n="Twitter Search Feed Test #4: big request manual refresh test",r=n.replace(/\s+/g,"");removeLocalStorage(n,function(){casper.reload(),casper.waitUntilVisible(inputSelector,function(){this.sendKeys(inputSelector,"test"),casper.waitUntilVisible(searchSubmitSelector,function(){casper.click(searchSubmitSelector),casper.waitUntilVisible(refreshSubmitSelector,function(){e.assertVisible(refreshSubmitSelector,n+" refresh displayed"),casper.wait(5e3),t=casper.evaluate(feedItemLength),e.assert(t>0,n+" has "+t+" results"),casper.click(refreshSubmitSelector);var i=function(){casper.wait(1e3);var i=casper.evaluate(feedItemLength);e.assert(i>t,n+" after manual refresh has "+i+" results which is >"+t)};casper.waitFor(function(){var e=casper.evaluate(feedItemLength);return e>t},i,i)},function(){casper.capture(r+"Fail.png"),e.assertExists(refreshSubmitSelector,n+" missing "+refreshSubmitSelector)})},function(){e.assertExists(searchSubmitSelector,n+" missing searchSubmit  "+searchSubmitSelector)})},function(){e.assertExists(inputSelector,n+" missing Input"+inputSelector)})})}),casper.then(function(){if(testsToRun.indexOf(5)!=-1){var t="Twiiter Search Feed Test #5: URL sent to the proxy with a non search url";casper.thenOpen(twitterSearchSite+"/twitter-proxy.php?url=statuses/home_timeline"),f=function(){e.assertTextExists(ProxyURLNotAuthorisedMsg,t)},casper.waitForText(ProxyURLNotAuthorisedMsg,f,f)}}),casper.then(function(){if(testsToRun.indexOf(6)!=-1){var t="Twitter Search Feed Test #6: URL sent to the proxy with too long a url";casper.thenOpen(twitterSearchSite+"/twitter-proxy.php?url=search/tweets.json?q=0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234"),f=function(){e.assertTextExists(ProxyURLTooLongMsg,t)},casper.waitForText(ProxyURLTooLongMsg,f,f)}}),casper.then(function(){if(testsToRun.indexOf(7)!=-1){var n="Twitter Search Feed Test #7: big request max feed items limit",r=n.replace(/\s+/g,"");casper.thenOpen(twitterSearchSite),removeLocalStorage(n),casper.thenOpen(twitterSearchSite,function(){t.enterTermAndClick(e,"a",n),casper.wait(1e3),casper.waitFor(function(){return feedItemLengthGreaterThan(14)},function(){var i=casper.evaluate(feedItemLength);e.assert(i>0,n+" loop 1 reached has "+i+" tweets which > 0 results"),casper.wait(3e3),casper.click(refreshSubmitSelector),casper.wait(1e3),casper.waitFor(function(){return feedItemLengthGreaterThan(i)},function(){var s=casper.evaluate(feedItemLength);casper.capture(r+"Loop2.png"),e.assert(s>i,n+" loop 2 reached has "+s+" tweets which > "+i+" results"),casper.wait(3e3),casper.click(refreshSubmitSelector),casper.wait(2e3),casper.waitFor(function(){return feedItemLengthGreaterThan(s)},function(){casper.capture(r+"Loop3.png");var i=casper.evaluate(feedItemLength);e.assert(i>s,n+" loop 3 reached has "+i+" tweets which > "+s+" results"),casper.wait(3e3),casper.click(refreshSubmitSelector),casper.wait(2e3),casper.waitFor(function(){return feedItemLengthGreaterThan(i)},function(){casper.capture(r+"Loop4.png");var s=casper.evaluate(feedItemLength);e.assert(s>i,n+" loop 4 reached has "+s+" tweets which > "+i+" results"),casper.wait(3e3),casper.click(refreshSubmitSelector),casper.wait(2e3),casper.waitFor(function(){return feedItemLengthGreaterThan(s)||s==maxItems},function(){var i=casper.evaluate(feedItemLength);casper.capture(r+"AfterLoopsPass.png"),e.assertEquals(maxItems,i,n+" after all loops reached has "+i+" results")},function(){casper.capture(r+"AfterLoopsFail.png"),e.assertExists(refreshSubmitSelector,n+" after all loops reached has feedItemLengthGreaterThan("+s+")")})},function(){e.assertExists(refreshSubmitSelector,n+" after loop 4 reached missing feedItemLengthGreaterThan("+i+")")})},function(){e.assertExists(refreshSubmitSelector,n+" after loop 3 reached missing feedItemLengthGreaterThan("+s+")")})},function(){e.assertExists(refreshSubmitSelector,n+" after loop 2 reached missing feedItemLengthGreaterThan("+i+")")})},function(){e.assertExists(refreshSubmitSelector,n+" ater loop 1 reached missing feedItemLengthGreaterThan(14)")})})}});if(testsToRun.indexOf(8)!=-1){var o="Twitter Search Feed Test #8: large input test",u=o.replace(/\s+/g,"");casper.thenOpen(twitterSearchSite,function(){removeLocalStorage(o)}),casper.waitForSelector(formInputSelector,function(){casper.click(formInputSelector)},function(){e.assertExists(formInputSelector,o+" missing "+formInputSelector)}),casper.waitForSelector(inputSelector,function(){this.sendKeys(inputSelector,"0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234")},function(){e.assertExists(inputSelector)}),casper.waitForSelector(inputSelector,function(){var n=casper.evaluate(queryValueFtn);e.assert(n.length===1e3,o+" truncated input at 1000 characters")},function(){e.assertExists(searchSubmitSelector,o+" missing "+searchSubmitSelector)})}if(testsToRun.indexOf(9)!=-1){casper.thenOpen(twitterSearchSite);var a="Twitter Search Feed Test #9: no search result test",l=a.replace(/\s+/g,"");removeLocalStorage(a),casper.waitForSelector(inputSelector,function(){this.sendKeys(inputSelector,"78901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567"),casper.waitForSelector(searchSubmitSelector,function(){casper.click(searchSubmitSelector)},function(){e.assertExists(searchSubmitSelector,a+" missing "+searchSubmitSelector)}),f=function(){e.assertTextExists(NoTweetResultsText,a+"No search results should be displayed")},casper.waitForText("No Tweet results for",f,f),f=function(){e.assertExists(searchSubmitSelector,a+" search submit should be displayed after no results")},casper.waitForSelector(searchSubmitSelector,f,function(){}),casper.waitForSelector(refreshSubmitSelector,function(){e.assertExists(refreshSubmitSelector,a+" should not have refresh displayed after no results")},function(){e.assertNotVisible(refreshSubmitSelector,a+" should not have refresh displayed after no results")})},function(){e.assertExists(inputSelector,a+" missing "+inputSelector)})}testsToRun.indexOf(10)!=-1&&casper.thenOpen(twitterSearchSite,function(){testText10="Twitter Search Feed Test #10: no input selected test",fileName10=testText10.replace(/\s+/g,""),removeLocalStorage(testText10),casper.waitForSelector(searchSubmitSelector,function(){casper.click(searchSubmitSelector),f=function(){e.assertExists(searchSubmitSelector,testText10+" search submit should be displayed after no search term")},casper.waitForSelector(searchSubmitSelector,f,function(){}),casper.waitForSelector(refreshSubmitSelector,function(){e.assertExists(refreshSubmitSelector,testText10+" submit should not have refresh displayed after no search term")},function(){e.assertNotVisible(refreshSubmitSelector,testText10+" submit should not have refresh displayed after no search term")})},function(){e.assertExists(searchSubmitSelector,testText10+" : missing "+searchSubmitSelector)})}),casper.then(function(){if(testsToRun.indexOf(11)!=-1){removeLocalStorage("test initializer"),casper.thenOpen(twitterSearchSite);var n="Twitter Search Feed Test #11: big request auto refresh",r=n.replace(/\s+/g,"");casper.then(function(){t.enterTermAndClick(e,"a",n),casper.waitUntilVisible(refreshSubmitSelector,function(){var r=casper.evaluate(feedItemLength);e.assertEquals(15,r,n+" has 15 results"),casper.click(refreshSubmitSelector)},function(){casper.capture(r+"Fail.png"),e.assertExists(refreshSubmitSelector,n+" missing "+refreshSubmitSelector)});var i=function(){var r=casper.evaluate(feedItemLength);e.assert(r>15,n+" after auto refresh has "+r+" tweets which is > 15")};casper.wait(autorefreshinterval+5e3),casper.waitForSelector(refreshSubmitSelector,i,i)})}}),casper.run(function(){casper.test.renderResults(!0),e.done()})},enterTermAndClick:function(e,t,n){casper.waitUntilVisible(formInputSelector,function(){casper.click(formInputSelector)},function(){casper.capture(n.replace(/\s+/g,"")+"NoFormInputSoFail.png"),e.assertExists(formInputSelector,n+" missing form Input "+formInputSelector)}),casper.waitUntilVisible(inputSelector,function(){this.sendKeys(inputSelector,"test")},function(){e.assertExists(inputSelector,n+" missing Input "+inputSelector)}),casper.waitUntilVisible(searchSubmitSelector,function(){casper.click(searchSubmitSelector)},function(){e.assertExists(searchSubmitSelector,n+" missing searchSubmit  "+searchSubmitSelector)})},waitForRefreshAndClick:function(e,t){casper.waitUntilVisible(refreshSubmitSelector,function(){casper.click(refreshSubmitSelector)},function(){casper.capture(t.replace(/\s+/g,"")+"NoRefreshSubmitSelectorFail.png"),e.assertExists(refreshSubmitSelector,t+" missing "+refreshSubmitSelector)})}});